<!DOCTYPE html>
<html>
  <head>
    <title>Astoria & IIS , HTTP 400 Bad Request on Posting Large Payloads to an astoria service – Phani Raj – Technical Lead at HP Cloud</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="We’ve seen this in the labs and also reported by our customers on the forums, If you try to post&nbsp; a large amount of data to an astoria data service , you might receive a response code Http 400 Bad Request even though the response data is valid. 
An ADO.NET Data Service sits on top of Windows Communication Foundation , although most of the required plumbing is hidden away from you&nbsp; ,&nbsp; you can still see the effects in scenarios such as this .
Why do I get a generic 400 Bad Request in this case ?
When the request size ( including headers ) exceeds 64 K ( 65536 bytes ) , WCF chokes on the request as this request size is greater than the limit on the maximum size of the request the service can recieve and sends out a HTTP 400 Bad Request as the request is invalid. 
How do I fix this ?
a)The maximum size of the request which a WCF service can process is controlled by the MaxReceivedMessageSize property on the WCF binding. The default value is 65536 ,exceeding which you get the 400 response code. 
In the web.config of the web site hosting the service , add the following node in the &lt;System.ServiceModel&gt; section. 

&lt;system.serviceModel&gt;
&lt;services&gt;
  &lt;!-- The name of the service --&gt;
  &lt;service name="NorthwindService"&gt;
    &lt;!-- you can leave the address blank or specify your end point URI --&gt;
    &lt;endpoint address ="YourServiceEndpoint"
              binding="webHttpBinding" bindingConfiguration="higherMessageSize"
     contract ="System.Data.Services.IRequestHandler"&gt;
    &lt;/endpoint&gt;
  &lt;/service&gt;
&lt;/services&gt;
&lt;bindings&gt;
  &lt;webHttpBinding&gt;
    &lt;!-- configure the maxReceivedMessageSize  value to suit the max size of 
         the request ( in bytes ) you want the service to recieve--&gt;
    &lt;binding name="higherMessageSize" maxReceivedMessageSize ="MaxMessageSize"/&gt;
  &lt;/webHttpBinding&gt;
&lt;/bindings&gt;
&lt;serviceHostingEnvironment aspNetCompatibilityEnabled="true"/&gt;
&lt;/system.serviceModel&gt;
b) If hosted on IIS , the ASP.Net Request Size restriction can also cause a large request to be rejected, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; You will need to set the HttpRuntimeSection.MaxRequestLength Property. 
&lt;system.web&gt;
  &lt;httpRuntime MaxRequestLength="ValueInKiloBytes" /&gt;
&lt;/system.web&gt;
How do I Identify if the reason I am seeing a 400 Bad Request&nbsp; is because of the request size ?
Identify if WCF is throwing an exception under the covers which is not being surfaced to you at the HTTP level. You can configure WCF tracing on the server-side to log the necessary information from the WCF layer. Once you have tracing setup and you reproduced the failure , check if the log contains one or both of these exception messages.&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; 
System.ServiceModel.ProtocolException
"The maximum message size quota for incoming messages (65536) has been exceeded.
To increase the quota, use the MaxReceivedMessageSize property on the appropriate binding element."

System.Web.HttpException
"Maximum request length exceeded."
If you see that the log does contain this message , then you can be sure that the failure is because of the message size and apply this fix accordingly.
" />
    <meta property="og:description" content="We’ve seen this in the labs and also reported by our customers on the forums, If you try to post&nbsp; a large amount of data to an astoria data service , you might receive a response code Http 400 Bad Request even though the response data is valid. 
An ADO.NET Data Service sits on top of Windows Communication Foundation , although most of the required plumbing is hidden away from you&nbsp; ,&nbsp; you can still see the effects in scenarios such as this .
Why do I get a generic 400 Bad Request in this case ?
When the request size ( including headers ) exceeds 64 K ( 65536 bytes ) , WCF chokes on the request as this request size is greater than the limit on the maximum size of the request the service can recieve and sends out a HTTP 400 Bad Request as the request is invalid. 
How do I fix this ?
a)The maximum size of the request which a WCF service can process is controlled by the MaxReceivedMessageSize property on the WCF binding. The default value is 65536 ,exceeding which you get the 400 response code. 
In the web.config of the web site hosting the service , add the following node in the &lt;System.ServiceModel&gt; section. 

&lt;system.serviceModel&gt;
&lt;services&gt;
  &lt;!-- The name of the service --&gt;
  &lt;service name="NorthwindService"&gt;
    &lt;!-- you can leave the address blank or specify your end point URI --&gt;
    &lt;endpoint address ="YourServiceEndpoint"
              binding="webHttpBinding" bindingConfiguration="higherMessageSize"
     contract ="System.Data.Services.IRequestHandler"&gt;
    &lt;/endpoint&gt;
  &lt;/service&gt;
&lt;/services&gt;
&lt;bindings&gt;
  &lt;webHttpBinding&gt;
    &lt;!-- configure the maxReceivedMessageSize  value to suit the max size of 
         the request ( in bytes ) you want the service to recieve--&gt;
    &lt;binding name="higherMessageSize" maxReceivedMessageSize ="MaxMessageSize"/&gt;
  &lt;/webHttpBinding&gt;
&lt;/bindings&gt;
&lt;serviceHostingEnvironment aspNetCompatibilityEnabled="true"/&gt;
&lt;/system.serviceModel&gt;
b) If hosted on IIS , the ASP.Net Request Size restriction can also cause a large request to be rejected, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; You will need to set the HttpRuntimeSection.MaxRequestLength Property. 
&lt;system.web&gt;
  &lt;httpRuntime MaxRequestLength="ValueInKiloBytes" /&gt;
&lt;/system.web&gt;
How do I Identify if the reason I am seeing a 400 Bad Request&nbsp; is because of the request size ?
Identify if WCF is throwing an exception under the covers which is not being surfaced to you at the HTTP level. You can configure WCF tracing on the server-side to log the necessary information from the WCF layer. Once you have tracing setup and you reproduced the failure , check if the log contains one or both of these exception messages.&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; 
System.ServiceModel.ProtocolException
"The maximum message size quota for incoming messages (65536) has been exceeded.
To increase the quota, use the MaxReceivedMessageSize property on the appropriate binding element."

System.Web.HttpException
"Maximum request length exceeded."
If you see that the log does contain this message , then you can be sure that the failure is because of the message size and apply this fix accordingly.
" />
    
    <meta name="author" content="Phani Raj" />

    
    <meta property="og:title" content="Astoria & IIS , HTTP 400 Bad Request on Posting Large Payloads to an astoria service" />
    <meta property="twitter:title" content="Astoria & IIS , HTTP 400 Bad Request on Posting Large Payloads to an astoria service" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Phani Raj - Technical Lead at HP Cloud" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://raw.githubusercontent.com/barryclark/jekyll-now/master/images/jekyll-logo.png" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Phani Raj</a></h1>
            <p class="site-description">Technical Lead at HP Cloud</p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Astoria & IIS , HTTP 400 Bad Request on Posting Large Payloads to an astoria service</h1>

  <div class="entry">
    <p>We’ve seen this in the labs and also reported by our customers on the forums, If you try to post&nbsp; a large amount of data to <br />an astoria data service , you might receive a response code Http 400 Bad Request even though the response data is valid. </p>
<p>An ADO.NET Data Service sits on top of Windows Communication Foundation , although most of the required plumbing is hidden away from you&nbsp; ,&nbsp; you can still see the effects in scenarios such as this .</p>
<h6>Why do I get a generic 400 Bad Request in this case ?</h6>
<p>When the request size ( including headers ) exceeds 64 K ( 65536 bytes ) , WCF chokes on the request as this request size is greater than the limit on the maximum size of the request the service can recieve and sends out a HTTP 400 Bad Request as the request is invalid. </p>
<h6>How do I fix this ?</h6>
<p>a)The maximum size of the request which a WCF service can process is controlled by the <a href="http://msdn.microsoft.com/en-us/library/system.servicemodel.channels.transportbindingelement.maxreceivedmessagesize.aspx" mce_href="http://msdn.microsoft.com/en-us/library/system.servicemodel.channels.transportbindingelement.maxreceivedmessagesize.aspx">MaxReceivedMessageSize</a> property on the WCF binding. <br />The default value is 65536 ,exceeding which you get the 400 response code. </p>
<p>In the web.config of the web site hosting the service , add the following node in the &lt;System.ServiceModel&gt; section. </p>
<p>
<pre class="darkcsharpcode"><span class="kwrd">&lt;</span><span class="html">system.serviceModel</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;</span><span class="html">services</span><span class="kwrd">&gt;</span>
  <span class="rem">&lt;!-- The name of the service --&gt;</span>
  <span class="kwrd">&lt;</span><span class="html">service</span> <span class="attr">name</span><span class="kwrd">="NorthwindService"</span><span class="kwrd">&gt;</span>
    <span class="rem">&lt;!-- you can leave the address blank or specify your end point URI --&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">endpoint</span> <span class="attr">address</span> <span class="kwrd">="YourServiceEndpoint"</span>
              <span class="attr">binding</span><span class="kwrd">="webHttpBinding"</span> <span class="attr">bindingConfiguration</span><span class="kwrd">="higherMessageSize"</span>
     <span class="attr">contract</span> <span class="kwrd">="System.Data.Services.IRequestHandler"</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">endpoint</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;/</span><span class="html">service</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">services</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;</span><span class="html">bindings</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;</span><span class="html">webHttpBinding</span><span class="kwrd">&gt;</span>
    <span class="rem">&lt;!-- configure the maxReceivedMessageSize  value to suit the max size of </span>
<span class="rem">         the request ( in bytes ) you want the service to recieve--&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">binding</span> <span class="attr">name</span><span class="kwrd">="higherMessageSize"</span> <span class="attr">maxReceivedMessageSize</span> <span class="kwrd">="MaxMessageSize"</span><span class="kwrd">/&gt;</span>
  <span class="kwrd">&lt;/</span><span class="html">webHttpBinding</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">bindings</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;</span><span class="html">serviceHostingEnvironment</span> <span class="attr">aspNetCompatibilityEnabled</span><span class="kwrd">="true"</span><span class="kwrd">/&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">system.serviceModel</span><span class="kwrd">&gt;</span></pre>
<p>b) If hosted on IIS , the ASP.Net Request Size restriction can also cause a large request to be rejected, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; You will need to set the <a href="http://msdn.microsoft.com/en-us/library/system.web.configuration.httpruntimesection.maxrequestlength.aspx" target="_blank" mce_href="http://msdn.microsoft.com/en-us/library/system.web.configuration.httpruntimesection.maxrequestlength.aspx">HttpRuntimeSection.MaxRequestLength</a> Property. </p>
<pre class="darkcsharpcode"><span class="kwrd">&lt;</span><span class="html">system.web</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;</span><span class="html">httpRuntime</span> <span class="attr">MaxRequestLength</span><span class="kwrd">="ValueInKiloBytes"</span> <span class="kwrd">/&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">system.web</span><span class="kwrd">&gt;</span></pre>
<h6>How do I Identify if the reason I am seeing a 400 Bad Request&nbsp; is because of the request size ?</h6>
<p>Identify if WCF is throwing an exception under the covers which is not being surfaced to you at the HTTP level. <br />You can <a title="Instructions on configuring WCF tracing" href="http://msdn.microsoft.com/en-us/library/ms733025.aspx" target="_blank" mce_href="http://msdn.microsoft.com/en-us/library/ms733025.aspx">configure WCF tracing</a> on the server-side to log the necessary information from the WCF layer. <br />Once you have tracing setup and you reproduced the failure , check if the log contains one or both of these exception messages.&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp; </p>
<pre class="darkcsharpcode">System.ServiceModel.ProtocolException
<span class="str">"The maximum message size quota for incoming messages (65536) has been exceeded.
To increase the quota, use the MaxReceivedMessageSize property on the appropriate binding element."
</span>
System.Web.HttpException
<span class="str">"Maximum request length exceeded."</span></pre>
<p>If you see that the log does contain this message , then you can be sure that the failure is because of the message size <br />and apply this fix accordingly.</p>

  </div>

  <div class="date">
    Written on October  6, 2008
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          



<a href="https://github.com/barryclark/jekyll-now"><i class="svg-icon github"></i></a>




<a href="https://www.twitter.com/jekyllrb"><i class="svg-icon twitter"></i></a>



        </footer>
      </div>
    </div>

    

  </body>
</html>
